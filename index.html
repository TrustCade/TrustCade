<script>
// ========================================
// FIXED SPIN WHEEL WITH 24-HOUR TIMER
// ========================================

class SpinWheel {
    constructor() {
        // Wheel elements
        this.canvas = document.getElementById('wheelCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.spinButton = document.getElementById('spinButton');
        this.timeLeftSpan = document.getElementById('timeLeft');
        
        // Timer elements
        this.hoursSpan = document.getElementById('hours');
        this.minutesSpan = document.getElementById('minutes');
        this.secondsSpan = document.getElementById('seconds');
        
        // Win notification
        this.winNotification = document.getElementById('winNotification');
        this.wonPrizeSpan = document.getElementById('wonPrize');
        this.wonValueSpan = document.getElementById('wonValue');
        
        // Wheel configuration
        this.centerX = this.canvas.width / 2;
        this.centerY = this.canvas.height / 2;
        this.radius = 200;
        
        // Prizes
        this.prizes = [
            { text: "iPhone 17", value: "$1,299", color: "#FF6B6B", weight: 1 },
            { text: "$500 Cash", value: "$500", color: "#4ECDC4", weight: 2 },
            { text: "Headphones", value: "$299", color: "#FFD166", weight: 3 },
            { text: "Try Again", value: "Next Spin", color: "#06D6A0", weight: 4 },
            { text: "PS5", value: "$499", color: "#118AB2", weight: 1 },
            { text: "$100 Card", value: "$100", color: "#EF476F", weight: 3 },
            { text: "Watch", value: "$399", color: "#073B4C", weight: 2 },
            { text: "MacBook", value: "$1,299", color: "#7209B7", weight: 1 }
        ];
        
        // Wheel state
        this.isSpinning = false;
        this.rotation = 0;
        this.lastSpinTime = localStorage.getItem('trustcade_last_spin');
        this.cooldownHours = 24;
        
        // Initialize
        this.init();
    }
    
    init() {
        // Draw initial wheel
        this.drawWheel();
        
        // Setup event listeners
        this.setupEventListeners();
        
        // Update button state based on time
        this.updateButtonState();
        
        // Start countdown timer
        this.startCountdown();
        
        // Close notification when X is clicked
        document.querySelector('.notification-close')?.addEventListener('click', () => {
            this.winNotification.style.display = 'none';
        });
    }
    
    drawWheel() {
        const ctx = this.ctx;
        const sliceAngle = (2 * Math.PI) / this.prizes.length;
        
        // Clear canvas
        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Draw each slice
        for (let i = 0; i < this.prizes.length; i++) {
            const startAngle = i * sliceAngle + this.rotation;
            const endAngle = startAngle + sliceAngle;
            
            // Draw slice
            ctx.beginPath();
            ctx.moveTo(this.centerX, this.centerY);
            ctx.arc(this.centerX, this.centerY, this.radius, startAngle, endAngle);
            ctx.closePath();
            
            // Fill slice with color
            ctx.fillStyle = this.prizes[i].color;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw text
            ctx.save();
            ctx.translate(this.centerX, this.centerY);
            ctx.rotate(startAngle + sliceAngle / 2);
            ctx.textAlign = 'right';
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(this.prizes[i].text, this.radius - 20, 5);
            ctx.restore();
        }
        
        // Draw center circle
        ctx.beginPath();
        ctx.arc(this.centerX, this.centerY, 20, 0, 2 * Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Draw pointer triangle
        ctx.beginPath();
        ctx.moveTo(this.centerX, 20);
        ctx.lineTo(this.centerX - 15, 60);
        ctx.lineTo(this.centerX + 15, 60);
        ctx.closePath();
        ctx.fillStyle = '#FF0000';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
    }
    
    setupEventListeners() {
        // Spin button click
        this.spinButton.addEventListener('click', () => this.spin());
        
        // Win notification claim button
        document.querySelector('.notification-btn')?.addEventListener('click', () => {
            this.winNotification.style.display = 'none';
        });
    }
    
    updateButtonState() {
        if (!this.lastSpinTime) {
            // First time user - can spin
            this.spinButton.disabled = false;
            this.spinButton.innerHTML = '<i class="fas fa-redo"></i> SPIN NOW<span class="btn-subtext">Free spin available!</span>';
            return;
        }
        
        const now = Date.now();
        const lastSpin = parseInt(this.lastSpinTime);
        const cooldownMs = this.cooldownHours * 60 * 60 * 1000;
        const nextSpinTime = lastSpin + cooldownMs;
        
        if (now >= nextSpinTime) {
            // Cooldown finished
            this.spinButton.disabled = false;
            this.spinButton.innerHTML = '<i class="fas fa-redo"></i> SPIN NOW<span class="btn-subtext">Free spin available!</span>';
        } else {
            // Still in cooldown
            this.spinButton.disabled = true;
            const remaining = nextSpinTime - now;
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            this.timeLeftSpan.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    startCountdown() {
        const updateTimer = () => {
            if (!this.lastSpinTime) {
                this.hoursSpan.textContent = '00';
                this.minutesSpan.textContent = '00';
                this.secondsSpan.textContent = '00';
                return;
            }
            
            const now = Date.now();
            const lastSpin = parseInt(this.lastSpinTime);
            const cooldownMs = this.cooldownHours * 60 * 60 * 1000;
            const nextSpinTime = lastSpin + cooldownMs;
            const remaining = nextSpinTime - now;
            
            if (remaining <= 0) {
                this.hoursSpan.textContent = '00';
                this.minutesSpan.textContent = '00';
                this.secondsSpan.textContent = '00';
                this.updateButtonState();
                return;
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            this.hoursSpan.textContent = hours.toString().padStart(2, '0');
            this.minutesSpan.textContent = minutes.toString().padStart(2, '0');
            this.secondsSpan.textContent = seconds.toString().padStart(2, '0');
            
            // Update button text as well
            if (this.spinButton.disabled) {
                this.timeLeftSpan.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        };
        
        updateTimer();
        setInterval(updateTimer, 1000);
    }
    
    async spin() {
        if (this.isSpinning || this.spinButton.disabled) {
            return;
        }
        
        // Check if user can spin
        if (this.lastSpinTime) {
            const now = Date.now();
            const lastSpin = parseInt(this.lastSpinTime);
            const cooldownMs = this.cooldownHours * 60 * 60 * 1000;
            const nextSpinTime = lastSpin + cooldownMs;
            
            if (now < nextSpinTime) {
                return;
            }
        }
        
        this.isSpinning = true;
        this.spinButton.disabled = true;
        this.spinButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SPINNING...';
        
        // Select a prize (weighted random)
        const selectedPrize = this.selectWeightedPrize();
        
        // Calculate rotation for selected prize
        const sliceAngle = (2 * Math.PI) / this.prizes.length;
        const prizeIndex = this.prizes.findIndex(p => p.text === selectedPrize.text);
        const targetRotation = 4 * Math.PI + (Math.PI * 2 - (prizeIndex * sliceAngle + sliceAngle / 2));
        
        // Animate spin
        const spinDuration = 4000; // 4 seconds
        const startTime = Date.now();
        const startRotation = this.rotation;
        
        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / spinDuration, 1);
            
            // Easing function for smooth spin
            const easeOut = 1 - Math.pow(1 - progress, 3);
            
            this.rotation = startRotation + (targetRotation * easeOut);
            this.drawWheel();
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                // Spin complete
                this.onSpinComplete(selectedPrize);
            }
        };
        
        requestAnimationFrame(animate);
    }
    
    selectWeightedPrize() {
        // Weighted random selection
        const totalWeight = this.prizes.reduce((sum, prize) => sum + prize.weight, 0);
        let random = Math.random() * totalWeight;
        
        for (const prize of this.prizes) {
            random -= prize.weight;
            if (random <= 0) {
                return prize;
            }
        }
        
        return this.prizes[0];
    }
    
    onSpinComplete(prize) {
        this.isSpinning = false;
        
        // Save spin time
        localStorage.setItem('trustcade_last_spin', Date.now().toString());
        
        // Update button for next spin
        this.lastSpinTime = Date.now().toString();
        this.updateButtonState();
        
        // Show win notification if prize has value
        if (prize.value !== "Next Spin") {
            this.showWinNotification(prize);
        } else {
            // Show "try again" message
            setTimeout(() => {
                alert("Better luck next time! Your next free spin will be available in 24 hours.");
            }, 500);
        }
        
        // Update statistics
        this.updateStatistics();
    }
    
    showWinNotification(prize) {
        this.wonPrizeSpan.textContent = prize.text;
        this.wonValueSpan.textContent = prize.value;
        this.winNotification.style.display = 'flex';
        
        // Add to user's wins if logged in
        const user = JSON.parse(localStorage.getItem('trustcade_user') || '{}');
        if (user.id) {
            const wins = JSON.parse(localStorage.getItem('trustcade_wins') || '[]');
            wins.push({
                id: Date.now(),
                prize: prize.text,
                value: prize.value,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                status: 'pending'
            });
            localStorage.setItem('trustcade_wins', JSON.stringify(wins));
        }
    }
    
    updateStatistics() {
        // Update live stats
        const winsToday = document.getElementById('winsToday');
        if (winsToday) {
            const currentWins = parseInt(winsToday.textContent) || 324;
            winsToday.textContent = currentWins + 1;
        }
        
        const totalValue = document.getElementById('totalValue');
        if (totalValue) {
            const currentValue = parseInt(totalValue.textContent.replace(/[^0-9]/g, '')) || 892450;
            // Add small random amount to simulate prize value
            totalValue.textContent = `$${(currentValue + 250).toLocaleString()}`;
        }
        
        const lastUpdated = document.getElementById('lastUpdated');
        if (lastUpdated) {
            lastUpdated.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Create and initialize spin wheel
    window.spinWheel = new SpinWheel();
    
    // Mobile menu functionality
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                mobileMenu.classList.remove('active');
            }
        });
    }
    
    // Login modal functionality
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('loginModal');
    const modalClose = document.querySelector('.modal-close');
    
    if (loginBtn && loginModal) {
        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.style.display = 'block';
        });
        
        if (modalClose) {
            modalClose.addEventListener('click', () => {
                loginModal.style.display = 'none';
            });
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
    }
    
    // Load recent winners
    loadRecentWinners();
    loadLeaderboard();
    
    // Update grand prize timer
    updateGrandPrizeTimer();
});

// Load recent winners
function loadRecentWinners() {
    const winnersGrid = document.getElementById('recentWinnersGrid');
    if (!winnersGrid) return;
    
    const winners = [
        { name: "LuckyStar23", prize: "iPhone 17 Pro", time: "2 hours ago", avatar: "LS" },
        { name: "MikeWins", prize: "$500 Cash", time: "4 hours ago", avatar: "MW" },
        { name: "SarahG", prize: "PS5 Pro", time: "6 hours ago", avatar: "SG" },
        { name: "PrizeHunter", prize: "MacBook Pro", time: "8 hours ago", avatar: "PH" }
    ];
    
    winnersGrid.innerHTML = winners.map(winner => `
        <div class="winner-card">
            <div class="winner-avatar">${winner.avatar}</div>
            <div class="winner-info">
                <h4>${winner.name}</h4>
                <p>Won: ${winner.prize}</p>
                <span class="win-time">${winner.time}</span>
            </div>
        </div>
    `).join('');
}

// Load leaderboard
function loadLeaderboard() {
    const leaderboard = document.getElementById('leaderboard');
    if (!leaderboard) return;
    
    const players = [
        { rank: 1, name: "LuckyStar23", wins: 12, value: "$8,450", status: "Verified" },
        { rank: 2, name: "MikeWins", wins: 9, value: "$5,200", status: "Verified" },
        { rank: 3, name: "SarahG", wins: 7, value: "$4,100", status: "Verified" },
        { rank: 4, name: "PrizeHunter", wins: 6, value: "$3,800", status: "Pending" },
        { rank: 5, name: "SpinKing", wins: 5, value: "$2,950", status: "Verified" }
    ];
    
    leaderboard.innerHTML = players.map(player => `
        <div class="leaderboard-item">
            <span class="rank">#${player.rank}</span>
            <span class="player">
                <span class="player-name">${player.name}</span>
                ${player.status === 'Verified' ? '<span class="verified-badge"><i class="fas fa-check-circle"></i></span>' : ''}
            </span>
            <span class="wins">${player.wins} wins</span>
            <span class="value">${player.value}</span>
            <span class="status ${player.status.toLowerCase()}">${player.status}</span>
        </div>
    `).join('');
}

// Update grand prize timer
function updateGrandPrizeTimer() {
    const timerElement = document.getElementById('grandPrizeTimer');
    if (!timerElement) return;
    
    // Set timer to end at midnight
    const now = new Date();
    const endOfDay = new Date();
    endOfDay.setHours(24, 0, 0, 0);
    
    const update = () => {
        const now = new Date();
        const diff = endOfDay - now;
        
        if (diff <= 0) {
            timerElement.textContent = "00:00:00";
            return;
        }
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    };
    
    update();
    setInterval(update, 1000);
}
</script>
